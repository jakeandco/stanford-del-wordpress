name: Verify Build

on:
  pull_request: { types: [opened, synchronize, reopened] } # PRs → Multidev
  push:
    branches: [main] # main → Dev

jobs:
  verify:
    runs-on: ubuntu-latest
    permissions:
      deployments: write
      contents: read
      pull-requests: read
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1 # ensure shallow (default is 1, but we make it explicit)

      # PHP for Composer
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none

      # Cache Composer (theme dir)
      - name: Cache Composer deps
        uses: actions/cache@v4
        with:
          path: web/app/themes/limerock/vendor
          key: composer-${{ runner.os }}-${{ hashFiles('web/app/themes/limerock/composer.lock') }}

      # Install theme Composer dependencies
      - name: Composer install (theme)
        working-directory: web/app/themes/limerock
        run: composer install --no-dev --prefer-dist --no-interaction --no-progress

      # Node for theme build
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/app/themes/limerock/package-lock.json

      # Build theme assets
      - name: Install & build (theme)
        working-directory: web/app/themes/limerock
        run: |
          npm ci
          npm run build